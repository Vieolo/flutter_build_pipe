name: Publish to pub.dev & Create GitHub release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  publish-pubdev:
    permissions:
      id-token: write # Required for authentication using OIDC
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
    # with:
    #   working-directory: path/to/package/within/repository
  github-release:
    needs: publish-pubdev
    runs-on: ubuntu-latest
    permissions:
      contents: write # GitHub release creation
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Read Changelog
        id: changelog
        shell: bash
        run: |
          TAG_NAME=$(git describe --tags --abbrev=0)
          VERSION="${TAG_NAME#v}"

          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"

          sed -n "/^##[[:space:]]\+$VERSION$/,/^##[[:space:]]/{
            /^##[[:space:]]\+$VERSION$/p
            /^##[[:space:]]/{
              /^##[[:space:]]\+$VERSION$/!q
            }
            p
          }" CHANGELOG.md > "${{ runner.temp }}/release_notes.txt"

          if [ ! -s "${{ runner.temp }}/release_notes.txt" ]; then
            echo "Changelog entry for version $VERSION not found"
            exit 1
          fi

          cat "${{ runner.temp }}/release_notes.txt"

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body_path: ${{ runner.temp }}/release_notes.txt
          draft: false
          prerelease: false
        
